#!/usr/bin/env python

import re
import subprocess
import sys

ARG_WT = '--work-tree=/home/menato/webapps/blog/entries'
ARG_GD = '--git-dir=/home/menato/webapps/git/repos/blog.git'

if __name__ == '__main__':
    master_re = re.compile('.*/master$')

    for line in sys.stdin.xreadlines():
        old, new, ref = line.strip().split(' ')
        if not master_re.match(ref):
            continue

        subprocess.call(['git', ARG_WT, ARG_GD, 'checkout', '-f'])
        p = subprocess.Popen(['git', ARG_GD, 'diff', '--name-only', old, new],
            stdout=subprocess.PIPE, stderr=subprocess.PIPE)

        out, err = p.communicate()
        print out

# while read oldrev newrev ref
# do
#     echo "oldrev = $oldrev"
#     echo "newrev = $newrev"
#     echo "ref = $ref"
#     if [[ $ref =~ .*/master$ ]];
#     then
#         git --work-tree=/home/menato/webapps/blog/entries --git-dir=/home/menato/webapps/git/repos/blog.git checkout -f
#         affected=($(git --git-dir=/home/menato/webapps/git/repos/blog.git diff --name-only $oldrev $newrev))
#         for file in ${affected[@]}
#         do
#             echo "affected file: $file"
#         done
#         echo "Ref $ref received, deployd to production."
#     else
#         echo "Ref $ref received, but it is not a master."
#     fi
# done
